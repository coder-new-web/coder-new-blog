---
title: http缓存
date: 2022-03-01
category:
  - 网络与网络安全
tag:
  - http缓存
---

之前当HTTP缓存还没有诞生的时候，当时的服务器需要处理太多请求，会给服务器带来极大的负荷。
然后http就出现了以后缓存类的东西，即HTTP缓存。HTTP缓存诞生的意义也就是使得网页打开速度更快，使得服务器压力减小，也减少了对服务器没必要的过多请求。

但是此时也发现了问题，用户一昧加载HTTP缓存内容，会导致当服务器资源更新的时候，HTTP缓存并不能及时拿到服务器最新的资源。此时最初是提议给HTTP缓存设置个过期时间，而设置这个过期时间的作用就是，不仅能继续发挥HTTP缓存的作用，还能拿到服务器最新的资源。此时过期时间就此诞生，即Expires。Expires的值就是一个过期时间，格式为`Tue ,27 Sep 2022 08:41:00 GMT`。当浏览器拿到这个值就可以决定缓存有没有过期。
此时请求流程就变成了：浏览器请求服务器，然后服务器返回资源并在响应头里返回Expires字段，值为过期时间。然后浏览器拿到这个值后，就可以根据Expires是否过期，在不过期的时间内继续访问HTTP缓存。

此时又出现了一个问题，Expires是服务端返回的，是服务端的时间，但是浏览器对比的却是客户端的时间，如果客户端时间和服务端时间不一致怎么办？如果客户端时间和服务端时间不一致的话，那么这个缓存就不准确了。
接近着就诞生了`Cache-Control`，这个准确来说是在HTTP1.1的时候引入的，作用跟Expires是一致的，但是不同的是，它采用的是过期时长，格式为`Cache-Control:max-age=3600`，`max-age`单位为毫秒。相比什么时候过期，过多久后过期就会准确很多（即过期时间和过期时长）。

**Cache-Control更多配置参数：**

| **参数名** | **说明**                             |
| ---------- | ------------------------------------ |
| max-age    | 单位秒                               |
| no-cache   | 不使用强缓存                         |
| no-store   | 禁止缓存                             |
| private    | 只有浏览器可以缓存                   |
| public     | 浏览器，服务器，代理服务器都可以缓存 |

往后的请求流程：浏览器请求服务器，服务器返回资源的时候，在响应头里增加Cache-Control这个字段，值包含了过期时长，然后浏览器就可以根据过期时长决定资源有没有过期。如果没有过期，浏览器就直接跟HTTP缓存打交道。

然后又遇到了问题，服务器因为资源过期又处理了很多请求，然后HTTP缓存内部分为了强缓存和协商缓存。
强缓存就是在缓存没有过期的时候，浏览器可以直接决定使用缓存，叫做强缓存。
协商缓存顾名思义就是有协商缓存的过程，就是当缓存过期后，浏览器需要资源服务器是否可以继续使用缓存，此时服务器就可以告诉浏览器是否继续是否缓存。

如何实现协商的过程？
即又诞生了`Last-Modified`，顾名思义就是最后修改时间。
之后的请求流程就又变成了：
浏览器请求服务器，服务器返回资源的同时在请求头了返回`Last-Modified`字段，值就是服务器资源最后的修改时间，然后浏览器请求的时候，每次请求都会携带`If-Modified-Since`，值就是`Last-Modified`，服务器拿到`If-Modified-Since`的值就会跟最后修改时间去做对比，如果比对结果是没有变化就返回304，告诉浏览器资源不过时，可以继续使用。如果比对结果为发生了变化，就会返回新的资源给浏览器，返回200。

但是又有了新问题，即服务器有新资源却仍然返回304给浏览器，导致浏览器资源更新不及时。原因在于`Last-Modified`单位是以秒为级别的，即在1秒内资源发生更改（服务器在一秒内把资源更新完了？），`Last-Modified`是无感知的，会认为没有变化，这也就是产生的原因。

为解决这个问题，就又诞生了Etag，往后的请求流程变成：
浏览器向服务器发送请求，服务器根据文件内容生成唯一标识，然后这个标识通过响应头ETag字段返回给浏览器，然后浏览器每次请求都会增加一个字段`If-None-Match`，值就是ETag的值。
服务器拿到`If-None-Match`就会对比当前的ETag，如果对比没变化就会返回304告诉浏览器可以继续使用，过时了就会返回新的资源。
